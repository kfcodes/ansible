---
- name: Wait until container is running
  community.docker.docker_container_info:
    name: "{{ app.container_name | default(app.name) }}"
  register: container_info
  retries: "{{ app.healthcheck.retries | default(10) }}"
  delay: "{{ app.healthcheck.delay | default(3) }}"
  until:
    - container_info.container is defined
    - container_info.container.State is defined
    - container_info.container.State.Status == "running"
  when:
    - service_state == 'present'
    - app.healthcheck.enabled | default(true) | bool

- name: HTTP healthcheck (optional)
  ansible.builtin.uri:
    url: >-
      {{
        app.healthcheck.url
        if (app.healthcheck.url is defined and app.healthcheck.url | length > 0)
        else omit
      }}
    status_code: "{{ app.healthcheck.status_code | default(200) }}"
  register: healthcheck_result
  retries: "{{ app.healthcheck.retries | default(10) }}"
  delay: "{{ app.healthcheck.delay | default(3) }}"
  until: healthcheck_result.status == (app.healthcheck.status_code | default(200))
  when:
    - service_state == 'present'
    - app.healthcheck.enabled | default(true) | bool
    - app.healthcheck.url is defined
    - app.healthcheck.url | length > 0

- name: Wait until container is running
  community.docker.docker_container_info:
    name: "{{ container_service_container_name }}"
  register: container_info
  retries: "{{ container_service_effective_healthcheck.retries }}"
  delay: "{{ container_service_effective_healthcheck.delay }}"
  until:
    - container_info.container is defined
    - container_info.container.State is defined
    - container_info.container.State.Status == "running"
  when:
    - service_state == 'present'
    - container_service_effective_healthcheck.enabled | bool

- name: HTTP healthcheck (optional)
  ansible.builtin.uri:
    url: "{{ container_service_effective_healthcheck.url }}"
    status_code: "{{ container_service_effective_healthcheck.status_code }}"
  register: healthcheck_result
  retries: "{{ container_service_effective_healthcheck.retries }}"
  delay: "{{ container_service_effective_healthcheck.delay }}"
  until: healthcheck_result.status == container_service_effective_healthcheck.status_code
  when:
    - service_state == 'present'
    - container_service_effective_healthcheck.enabled | bool
    - container_service_effective_healthcheck.url | length > 0
