---
- name: Ensure external Docker networks exist (optional)
  community.docker.docker_network:
    name: "{{ item }}"
    state: present
  loop: "{{ app.networks | default([]) }}"
  when:
    - service_manage_networks | bool
    - app.networks is defined
    - app.networks | length > 0

- name: Deploy service with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ app.path }}"
    state: present
    pull: "{{ compose_pull }}"
    recreate: "{{ compose_recreate }}"
    remove_orphans: "{{ compose_remove_orphans }}"
    build: "{{ compose_build }}"
  when: service_state == 'present'

- name: Remove service with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ app.path }}"
    state: absent
    remove_orphans: true
  when: service_state == 'absent'
