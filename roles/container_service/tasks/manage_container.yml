---
- name: Ensure external Docker networks exist
  community.docker.docker_network:
    name: "{{ item }}"
    state: present
  loop: "{{ container_service_networks }}"
  when:
    - service_manage_networks | bool
    - container_service_networks | length > 0

- name: Compute whether we need to build
  ansible.builtin.set_fact:
    container_service_needs_build: >-
      {{
        (repo_result is defined and repo_result.changed)
        or (compose_template_result is defined and compose_template_result.changed)
        or (dockerfile_template_result is defined and dockerfile_template_result.changed)
      }}
  when: service_state == 'present'

- name: Deploy service with Docker Compose v2 (build only if needed)
  community.docker.docker_compose_v2:
    project_src: "{{ container_service_app_path }}"
    state: present
    pull: "{{ compose_pull }}"
    recreate: "{{ compose_recreate }}"
    remove_orphans: "{{ compose_remove_orphans }}"
    build: "{{ container_service_needs_build | default(false) }}"
  when: service_state == 'present'

- name: Remove service with Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: "{{ container_service_app_path }}"
    state: absent
    remove_orphans: true
  when: service_state == 'absent'
