#!/usr/bin/env bash
set -euo pipefail

if [[ "${EUID}" -ne 0 ]]; then
  echo "Run as root: sudo $0" >&2
  exit 1
fi

echo "[vfio-enable] Switching to VFIO mode..."

IDS="{{ gpu_pci_ids | join(',') }}"

GRUB_FILE="/etc/default/grub"

get_cmdline() {
  sed -n 's/^GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*\)"/\1/p' "$GRUB_FILE" | head -n1
}

set_cmdline() {
  local new="$1"
  # normalize spaces
  new="$(echo "$new" | xargs)"
  sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=\"[^\"]*\"/GRUB_CMDLINE_LINUX_DEFAULT=\"${new}\"/" "$GRUB_FILE"
}

strip_tokens() {
  # remove vfio-only and other mode-specific bits
  echo "$1" \
    | sed -E 's/\<vfio-pci\.ids=[^ ]+\>//g' \
    | sed -E 's/\<rd\.driver\.pre=vfio-pci\>//g' \
    | sed -E 's/\<modprobe\.blacklist=amdgpu\>//g' \
    | sed -E 's/\<modprobe\.blacklist=snd_hda_intel\>//g' \
    | sed -E 's/\<video=efifb:off\>//g' \
    | sed -E 's/\<intel_iommu=on\>//g' \
    | sed -E 's/\<amd_iommu=on\>//g' \
    | sed -E 's/\<iommu=pt\>//g'
}

ensure_token() {
  local cmd="$1"
  local tok="$2"
  if ! echo "$cmd" | grep -qw "$tok"; then
    cmd="$cmd $tok"
  fi
  echo "$cmd"
}

cmd="$(get_cmdline)"
cmd="$(strip_tokens "$cmd")"

# Base tokens (always)
cmd="$(ensure_token "$cmd" "iommu=pt")"
{% if iommu_platform == "intel" %}
cmd="$(ensure_token "$cmd" "intel_iommu=on")"
{% else %}
cmd="$(ensure_token "$cmd" "amd_iommu=on")"
{% endif %}

# VFIO-only tokens
cmd="$(ensure_token "$cmd" "vfio-pci.ids=${IDS}")"
cmd="$(ensure_token "$cmd" "rd.driver.pre=vfio-pci")"
cmd="$(ensure_token "$cmd" "modprobe.blacklist=amdgpu")"
{% if disable_efi_framebuffer | bool %}
cmd="$(ensure_token "$cmd" "video=efifb:off")"
{% endif %}

set_cmdline "$cmd"

echo "[vfio-enable] GRUB cmdline now:"
grep '^GRUB_CMDLINE_LINUX_DEFAULT=' "$GRUB_FILE" || true

update-grub
update-initramfs -u

echo "[vfio-enable] Rebooting..."
reboot
