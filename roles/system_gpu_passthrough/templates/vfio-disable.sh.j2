#!/usr/bin/env bash
set -euo pipefail

if [[ "${EUID}" -ne 0 ]]; then
  echo "Run as root: sudo $0" >&2
  exit 1
fi

echo "[vfio-disable] Switching to HOST mode..."

GRUB_FILE="/etc/default/grub"

get_cmdline() {
  sed -n 's/^GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*\)"/\1/p' "$GRUB_FILE" | head -n1
}

set_cmdline() {
  local new="$1"
  new="$(echo "$new" | xargs)"
  sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=\"[^\"]*\"/GRUB_CMDLINE_LINUX_DEFAULT=\"${new}\"/" "$GRUB_FILE"
}

strip_tokens() {
  echo "$1" \
    | sed -E 's/\<vfio-pci\.ids=[^ ]+\>//g' \
    | sed -E 's/\<rd\.driver\.pre=vfio-pci\>//g' \
    | sed -E 's/\<modprobe\.blacklist=amdgpu\>//g' \
    | sed -E 's/\<modprobe\.blacklist=snd_hda_intel\>//g' \
    | sed -E 's/\<video=efifb:off\>//g' \
    | sed -E 's/\<intel_iommu=on\>//g' \
    | sed -E 's/\<amd_iommu=on\>//g' \
    | sed -E 's/\<iommu=pt\>//g'
}

ensure_token() {
  local cmd="$1"
  local tok="$2"
  if ! echo "$cmd" | grep -qw "$tok"; then
    cmd="$cmd $tok"
  fi
  echo "$cmd"
}

cmd="$(get_cmdline)"
cmd="$(strip_tokens "$cmd")"

cmd="$(ensure_token "$cmd" "iommu=pt")"
{% if iommu_platform == "intel" %}
cmd="$(ensure_token "$cmd" "intel_iommu=on")"
{% else %}
cmd="$(ensure_token "$cmd" "amd_iommu=on")"
{% endif %}

set_cmdline "$cmd"

echo "[vfio-disable] GRUB cmdline now:"
grep '^GRUB_CMDLINE_LINUX_DEFAULT=' "$GRUB_FILE" || true

echo "[vfio-disable] Removing any vfio-pci ids modprobe files..."
rm -f /etc/modprobe.d/vfio-pci-ids.conf
rm -f /etc/modprobe.d/vfio.conf

# Also remove any other leftovers created by older iterations (safe no-op if not present)
rm -f /etc/modprobe.d/*vfio*ids*.conf 2>/dev/null || true

update-grub
update-initramfs -u

echo "[vfio-disable] Rebooting..."
reboot
