#!/usr/bin/env bash
set -euo pipefail

echo "[vfio-disable] Enabling HOST mode and rebooting..."

# Remove vfio-only bits + wrong amd flag
sudo sed -i 's/\<vfio-pci\.ids=[^ ]*\>//g' /etc/default/grub
sudo sed -i 's/\<rd\.driver\.pre=vfio-pci\>//g' /etc/default/grub
sudo sed -i 's/\<modprobe\.blacklist=amdgpu\>//g' /etc/default/grub
sudo sed -i 's/\<video=efifb:off\>//g' /etc/default/grub
sudo sed -i 's/\<amd_iommu=on\>//g' /etc/default/grub

# Keep Intel IOMMU base (fine in host mode too)
sudo grep -q 'intel_iommu=on' /etc/default/grub || \
  sudo sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 intel_iommu=on"/' /etc/default/grub

sudo grep -q 'iommu=pt' /etc/default/grub || \
  sudo sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="\([^"]*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 iommu=pt"/' /etc/default/grub

sudo update-grub
sudo update-initramfs -u

echo "[vfio-disable] Rebooting now..."
sudo reboot
