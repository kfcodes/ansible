---
- name: Sanity check required vars
  include_tasks: sanity.yml

- name: Install virtualization packages
  include_tasks: install.yml
  tags: [install]

- name: Configure VFIO modules and modprobe config
  include_tasks: vfio.yml
  tags: [vfio]

- name: Configure GRUB for IOMMU + mode-specific VFIO binding
  include_tasks: grub.yml
  tags: [grub]

- name: Install VFIO mode toggle scripts
  include_tasks: mode_scripts.yml
  tags: [scripts]

- name: Optionally create VM (headless-friendly)
  include_tasks: create_vm.yml
  when: create_vm | bool
  tags: [vm]

- name: Optionally create Alpine demo VM for passthrough validation
  include_tasks: demo_vm.yml
  when: create_demo_vm | bool
  tags: [demo_vm]

- name: Reboot now if required (flush handlers at end of role)
  meta: flush_handlers
