---
- name: Read /etc/default/grub (slurp)
  slurp:
    path: /etc/default/grub
  register: grub_file

- name: Decode grub file content
  set_fact:
    grub_file_text: "{{ grub_file.content | b64decode }}"

- name: Extract current GRUB_CMDLINE_LINUX_DEFAULT (safe)
  set_fact:
    grub_cmdline_current_str: >-
      {{
        (grub_file_text
          | regex_search('^GRUB_CMDLINE_LINUX_DEFAULT=(\"[^\"]*\"|\\x27[^\\x27]*\\x27|[^\\n]*)', multiline=True)
          | default('GRUB_CMDLINE_LINUX_DEFAULT=\"\"'))
        | regex_replace('^GRUB_CMDLINE_LINUX_DEFAULT=', '')
        | trim
        | regex_replace('^\"|\"$', '')
        | regex_replace("^\\x27|\\x27$", '')
      }}

- name: Split current cmdline into list
  set_fact:
    grub_cmdline_current: "{{ grub_cmdline_current_str.split(' ') | reject('equalto','') | list }}"

# Remove vfio-only args to keep host mode clean
- name: Remove existing vfio-only args (always do this first)
  set_fact:
    grub_cmdline_current: >-
      {{
        grub_cmdline_current
        | reject('search','^vfio-pci\\.ids=')
        | reject('equalto','rd.driver.pre=vfio-pci')
        | reject('equalto','video=efifb:off')
        | list
      }}

- name: Build always-on args (filter intel/amd correctly)
  set_fact:
    _always_args: >-
      {{
        grub_cmdline_always
        | reject('search','^intel_iommu=on$') | list
        if iommu_platform != 'intel' else grub_cmdline_always
      }}

- name: Filter AMD arg if not AMD platform
  set_fact:
    _always_args: >-
      {{
        _always_args
        | reject('search','^amd_iommu=on$') | list
        if iommu_platform != 'amd' else _always_args
      }}

- name: Start building desired args list
  set_fact:
    grub_cmdline_desired: "{{ (grub_cmdline_current + _always_args) | unique | list }}"

- name: Add VFIO-only args if vfio_mode == vfio
  set_fact:
    grub_cmdline_desired: "{{ (grub_cmdline_desired + grub_cmdline_vfio_only) | unique | list }}"
  when: vfio_mode == 'vfio'

- name: Optionally disable EFI framebuffer (ONLY in vfio mode)
  set_fact:
    grub_cmdline_desired: "{{ (grub_cmdline_desired + ['video=efifb:off']) | unique | list }}"
  when: disable_efi_framebuffer | bool and vfio_mode == 'vfio'

- name: Ensure GRUB_CMDLINE_LINUX_DEFAULT line exists (create if missing)
  lineinfile:
    path: /etc/default/grub
    regexp: "^GRUB_CMDLINE_LINUX_DEFAULT="
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ grub_cmdline_desired | join(" ") }}"'
    create: true
  notify:
    - update-grub
    - update-initramfs
    - reboot-host

- name: Flush handlers (apply grub + reboot now)
  meta: flush_handlers
