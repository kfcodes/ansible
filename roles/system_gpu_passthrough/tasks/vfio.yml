---
- name: Ensure VFIO modules load at boot (late)
  copy:
    dest: /etc/modules-load.d/vfio.conf
    mode: "0644"
    content: |
      vfio
      vfio_pci
      vfio_iommu_type1
      vfio_virqfd

- name: Ensure VFIO modules are included in initramfs (early) - Ubuntu
  blockinfile:
    path: /etc/initramfs-tools/modules
    create: true
    marker: "# {mark} ANSIBLE VFIO MODULES"
    block: |
      vfio
      vfio_pci
      vfio_iommu_type1
      vfio_virqfd
  notify:
    - update-initramfs

- name: Configure vfio-pci device IDs (modprobe)
  template:
    src: vfio.conf.j2
    dest: /etc/modprobe.d/vfio.conf
    mode: "0644"
  notify:
    - update-initramfs

# Toggleable setup: only blacklist host GPU drivers in VFIO mode, and only if enabled.
- name: Optionally blacklist host GPU drivers (ONLY in vfio mode)
  copy:
    dest: /etc/modprobe.d/blacklist-host-gpu.conf
    mode: "0644"
    content: |
      blacklist amdgpu
      blacklist radeon
      blacklist nouveau
      blacklist nvidia
  when: blacklist_host_gpu_drivers | bool and vfio_mode == 'vfio'
  notify:
    - update-initramfs

- name: Ensure blacklist file is absent in host mode (or if disabled)
  file:
    path: /etc/modprobe.d/blacklist-host-gpu.conf
    state: absent
  when: (not blacklist_host_gpu_drivers | bool) or (vfio_mode != 'vfio')
  notify:
    - update-initramfs

- name: Flush handlers so initramfs is updated before reboot-triggering steps
  meta: flush_handlers
