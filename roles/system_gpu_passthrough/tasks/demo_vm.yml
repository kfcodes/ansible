---
- name: Ensure ISO directory exists
  file:
    path: "{{ demo_iso_dir }}"
    state: directory
    mode: "0755"

- name: Download Alpine ISO (if missing)
  get_url:
    url: "{{ demo_iso_url }}"
    dest: "{{ demo_iso_path }}"
    mode: "0644"

- name: Ensure NVRAM directory exists
  file:
    path: "/var/lib/libvirt/qemu/nvram"
    state: directory
    mode: "0755"

- name: Copy OVMF VARS template for this VM (if missing)
  copy:
    src: "{{ ovmf_vars_template_path }}"
    dest: "{{ demo_nvram_path }}"
    remote_src: true
    force: false
    mode: "0644"

- name: Check if demo VM already exists
  command: "virsh dominfo {{ demo_vm_name }}"
  register: demo_vm_exists
  failed_when: false
  changed_when: false

- name: Render demo VM XML (for first run define)
  template:
    src: "alpine-vfio.xml.j2"
    dest: "/tmp/{{ demo_vm_name }}.xml"
    mode: "0644"
  when: demo_vm_exists.rc != 0

- name: Define demo VM (first run only)
  command: "virsh define /tmp/{{ demo_vm_name }}.xml"
  when: demo_vm_exists.rc != 0
  changed_when: true

- name: Get current VM state
  command: "virsh domstate {{ demo_vm_name }}"
  register: demo_vm_state
  failed_when: false
  changed_when: false

- name: Start demo VM if not running
  command: "virsh start {{ demo_vm_name }}"
  when:
    - demo_vm_exists.rc == 0 or demo_vm_exists.rc != 0 # VM should exist now
    - demo_vm_state.stdout is not search("running")
  register: demo_vm_start
  failed_when: false
  changed_when: demo_vm_start.rc == 0

- name: Demo VM status hint
  debug:
    msg:
      - "Demo VM '{{ demo_vm_name }}' exists: {{ demo_vm_exists.rc == 0 }}"
      - "State: {{ demo_vm_state.stdout | default('unknown') }}"
      - "Console: sudo virsh console {{ demo_vm_name }} (exit with Ctrl+])"
      - "If you change GPU/ISO/OVMF settings later, you will need to manually edit/redefine the VM or switch to Option A."
