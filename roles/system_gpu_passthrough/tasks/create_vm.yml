---
- name: Check if VM already exists
  command: "virsh dominfo {{ vm_name }}"
  register: vm_exists
  failed_when: false
  changed_when: false

- name: Create VM (first-time)
  command: >
    virt-install
    --name {{ vm_name }}
    --ram {{ vm_ram_mb }}
    --vcpus {{ vm_vcpus }}
    --cpu host-passthrough
    --machine q35
    --boot uefi
    --disk path={{ vm_disk_path }},size={{ vm_disk_gb }},bus=virtio,format=qcow2
    --cdrom {{ vm_iso_path }}
    --network network=default,model=virtio
    {% if vm_graphics == 'spice' %}
    --graphics spice,listen={{ vm_graphics_listen }}
    {% elif vm_graphics == 'vnc' %}
    --graphics vnc,listen={{ vm_graphics_listen }}
    {% else %}
    --graphics none
    --console pty,target_type=serial
    {% endif %}
    --noautoconsole
  when: vm_exists.rc != 0

- name: Reminder for headless access
  debug:
    msg: >
      VM created. For headless install, SSH tunnel to {{ vm_graphics_listen }} and connect with virt-viewer.
      After Windows installs, prefer RDP. GPU passthrough is already reserved via vfio-pci.ids at boot.
