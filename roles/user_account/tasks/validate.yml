---
- name: Validate managed_users is a list
  ansible.builtin.assert:
    that:
      - managed_users is iterable
    fail_msg: "managed_users must be a list (can be empty)."

- name: Skip role if no users defined
  ansible.builtin.debug:
    msg: "user_account: managed_users is empty for {{ inventory_hostname }}; skipping user creation/key management."
  when: managed_users | length == 0

- name: Validate each managed user entry (when provided)
  ansible.builtin.assert:
    that:
      - item.name is defined
      - (item.name | string | length) > 0
    fail_msg: "Each managed_users entry must include a non-empty 'name'."
  loop: "{{ managed_users }}"
  loop_control:
    label: "{{ item.name | default('undefined') }}"
  when: managed_users | length > 0

- name: Validate authorized_keys field shape (when key management enabled)
  ansible.builtin.assert:
    that:
      - item.authorized_keys is not defined or item.authorized_keys is iterable
    fail_msg: "managed_users[].authorized_keys must be a list of public key strings when provided."
  loop: "{{ managed_users }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - managed_users | length > 0
    - user_accounts_enable_key_mgmt | bool
