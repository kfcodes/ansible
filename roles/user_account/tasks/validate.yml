---
- name: Validate managed_users
  ansible.builtin.assert:
    that:
      - managed_users is iterable
      - managed_users | length > 0
      - (managed_users | map(attribute='name') | list | length) == (managed_users | length)
      - (managed_users | map(attribute='name') | select('string') | list | length) == (managed_users | length)
    fail_msg: "managed_users must be a non-empty list and each item must include a non-empty 'name'."

- name: Validate authorized_keys (when key management enabled)
  ansible.builtin.assert:
    that:
      - item.authorized_keys is not defined or item.authorized_keys is iterable
    fail_msg: "managed_users[].authorized_keys must be a list of key strings when provided."
  loop: "{{ managed_users }}"
  loop_control:
    label: "{{ item.name }}"
  when: user_accounts_enable_key_mgmt | bool
